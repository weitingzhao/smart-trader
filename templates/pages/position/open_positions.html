{% extends "layouts/base.html" %}
{% load static home_filter admin_soft%}
{% block content %}
    <div class="container-fluid">
        <div class="page-header min-height-150 border-radius-xl mt-4" style="background-image: url('{% static 'assets/img/curved-images/curved0.jpg' %}'); background-position-y: 50%;">
          <span class="mask bg-gradient-primary opacity-6"></span>
        </div>
        <div class="card card-body blur shadow-blur mx-4 mt-n6 overflow-hidden">
            <div class="row gx-4">
                <div class="col-auto">
                  <div class="avatar avatar-xl position-relative">
                      <img src="{% static 'assets/img/bruce-mars.jpg' %}" alt="profile_image" class="w-100 border-radius-lg shadow-sm">
                  </div>
              </div>
                <div class="col-auto my-auto">
                  <div class="h-100">
                      <h5 class="mb-1">
                          Open Positions
                      </h5>
                      <p class="mb-0 font-weight-bold text-sm">
                          <a href="javascript:void(0);" onclick="refreshSymbol('{{ summary.holding_symbols }}','5d', '1d','{{ csrf_token }}');">
                              {{ portfolio.name }}
                          </a>
                      </p>
                  </div>
              </div>
                <div class="col-lg-4 col-md-6 my-sm-auto ms-sm-auto me-sm-0 mx-auto mt-3">
                <div class="nav-wrapper position-relative end-0">
                    <ul class="nav nav-pills nav-fill p-1 bg-transparent" role="tablist">
                        <li class="nav-item">
                            <a id="summary_btn" class="nav-link mb-0 px-0 py-1 active " data-bs-toggle="tab" href="javascript:" role="tab" aria-selected="true">
                                <span class="ms-1">Summary</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a id="holding_btn" class="nav-link mb-0 px-0 py-1 " data-bs-toggle="tab" href="javascript:" role="tab" aria-selected="false">
                                <span class="ms-1">My Holdings</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a id="fundamental_btn" class="nav-link mb-0 px-0 py-1 " data-bs-toggle="tab" href="javascript:" role="tab" aria-selected="false">
                                <span class="ms-1">Fundamentals</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Main Section -->
    <div class="container-fluid py-3">
        <div class="row py-3">
            <div class="col-xl-4 col-sm-6 mb-xl-0 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-8">
                                <div class="numbers">
                                    <div class="d-flex align-items-center">
                                        <p class="text-sm mb-0 text-capitalize font-weight-bold">Today's Market</p>
                                        &nbsp;&nbsp;&nbsp;
                                        <p class="text-sm mb-0">percent / dollar</p>
                                    </div>
                                    <h5 class="font-weight-bolder mb-0">
                                        {% round_by_digits summary.mv.value 2 '$ {0}' False %}
                                        <span class="{% if summary.mv.percent > 0 %}text-success{% elif summary.mv.percent < 0 %}text-danger{% else %}text-dark{% endif %} text-sm font-weight-bolder">
                                            {% round_by_digits summary.mv.percent 2 '{0}%' %}&nbsp;
                                            {% round_by_digits summary.mv.change 0 '  ${0}' False %}
                                        </span>
                                    </h5>
                                </div>
                            </div>
                            <div class="col-4 text-end">
                                <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                                    <i class="ni ni-money-coins text-lg opacity-10" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-4 col-sm-6 mb-xl-0 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-8">
                                <div class="numbers">
                                    <div class="d-flex align-items-center">
                                        <p class="text-sm mb-0 text-capitalize font-weight-bold">Distance</p>
                                        &nbsp;&nbsp;&nbsp;
                                        <p class="text-sm mb-0">gain / risk</p>
                                    </div>
                                    <h5 class="font-weight-bolder mb-0">
                                        {% round_by_digits summary.unrealized.dist 2 '$ {0}' False %}
                                        <span class="{% if summary.unrealized.gain > 0 %}text-success{% elif summary.unrealized.gain < 0 %}text-danger{% else %}text-dark{% endif %} text-sm font-weight-bolder">
                                            {% round_by_digits summary.unrealized.gain 0 '${0}' False %}
                                        </span>
                                        <span class="text-sm">/</span>
                                        <span class="{% if summary.unrealized.risk > 0 %}text-success{% elif summary.unrealized.risk < 0 %}text-danger{% else %}text-dark{% endif %} text-sm font-weight-bolder">
                                            {% round_by_digits summary.unrealized.risk 0 '${0}' False %}
                                        </span>
                                    </h5>
                                </div>
                            </div>
                            <div class="col-4 text-end">
                                <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                                    <i class="ni ni-world text-lg opacity-10" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-4 col-sm-6 mb-xl-0 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-8">
                                <div class="numbers">
                                    <div class="d-flex align-items-center">
                                        <p class="text-sm mb-0 text-capitalize font-weight-bold">Capital Risk</p>
                                        &nbsp;&nbsp;&nbsp;
                                        <p class="text-sm mb-0">above / dist</p>
                                    </div>
                                    <h5 class="font-weight-bolder mb-0">
                                        {% round_by_digits summary.water.below 0 '$ {0}' False %}
                                        <span class="{% if summary.water.above > 0 %}text-success{% elif summary.water.above < 0 %}text-danger{% else %}text-dark{% endif %} text-sm font-weight-bolder">
                                            {% round_by_digits summary.water.above 0 '${0}' False %}
                                        </span>
                                        <span class="text-sm">/</span>
                                        <span class="{% if summary.water.dist > 0 %}text-success{% elif summary.water.dist < 0 %}text-danger{% else %}text-dark{% endif %} text-sm font-weight-bolder">
                                            {% round_by_digits summary.water.dist 0 '${0}' False %}
                                        </span>
                                    </h5>
                                </div>
                            </div>
                            <div class="col-4 text-end">
                                <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                                    <i class="ni ni-paper-diploma text-lg opacity-10" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div id="summary_panel" class="col-12">
                <div class="card">
                  <div class="card-header pb-0">
                      <div class="d-flex align-items-center">
                          <p class="text-sm">
                              <span class="badge badge-md badge-dot me-4">
                                  <span class="text-dark text-xs">Phase Legend:</span>
                              </span>
                              <i class="fas fa-dollar-sign fa-lg" style="color:red"></i>
                              <span class="badge-dot me-4 text-dark text-xs">Earning</span>
                              <i class="fas fa-hourglass-start fa-lg" style="color:black"></i>
                              <span class="badge-dot me-4 text-dark text-xs">Before Breakout</span>
                              <i class="fas fa-hourglass-half fa-lg" style="color:#8c0404"></i>
                              <span class="badge-dot me-4 text-dark text-xs">Breaking Out</span>
                              <i class="fas fa-hourglass-end fa-lg" style="color:#8fda2d"></i>
                              <span class="badge-dot me-4 text-dark text-xs">After Breakout</span>
                              <i class="fas fa-stop fa-lg" style="color:grey"></i>
                              <span class="badge-dot me-4 text-dark text-xs">None</span>
                          </p>
                      </div>
                  </div>
                    <div class="card-body px-0 pb-0 p-0">
                        <div class="table-responsive">
                            <table class="table table-flush table-hover text-end" id="summary-list">
                                <thead class="thead-light">
                                <tr class="main-header">
                                    <!-- Market-->
                                    <th title="stock current phase">PH.</th>
                                    <th>SYMBOL</th>
                                    <th title="Current price per share and price change compared to the previous trading day.">$ SHARE<br>CHG</th>
                                    <th>%<br>CHG</th>
                                    <th>% DAY<br>CHG</th>
                                    <!-- Current Status -->
                                    <th class="bg-primary text-white">$ INVEST<br/>AMOUNT</th>
                                    <th class="bg-primary text-white">COST<br/>BASE</th>
                                    <th class="bg-primary text-white">STOP<br>LIMIT</th>
                                    <!-- Risk vs Margin -->
                                    <th class="bg-info text-white" title="the distance between margin and risk as dollar">$ <br>DIST</th>
                                    <th class="bg-info text-white" title="the distance between margin and risk as percent">% <br>DIST</th>
                                    <th class="bg-info text-white">%<br>RISK</th>
                                    <th class="bg-info text-white">% <br>GAIN</th>
                                    <th class="bg-info text-white">$ <br>RISK</th>
                                    <th class="bg-info text-white">% <br>GAIN</th>
                                    <!-- Goal -->
                                    <th class="bg-success text-white">CURRENT<br>vs INIT</th>
                                    <!-- Statistics -->
                                    <th class="bg-dark text-white">Holding<br>Days</th>
                                    <th class="bg-dark text-white">Industry<br>Sector</th>
                                    <!-- Entry Action -->
                                    <th class="bg-gray-200  text-dark">ENTRY<br/>DATE</th>
                                    <th class="bg-gray-200  text-dark">$ INVEST<br/>AMOUNT</th>
                                    <th class="bg-gray-200  text-dark">$ INITIAL<br/>ACTION</th>
                                </tr>
                                <tr class="subheader">
                                    <th colspan="5">MARKET</th>
                                    <th colspan="3" class="bg-primary text-white">Current Status</th>
                                    <th colspan="6" class="bg-info text-white">Risk vs Margin</th>
                                    <th colspan="1" class="bg-success text-white">Goal</th>
                                    <th colspan="2" class="bg-dark text-white">Statistics</th>
                                    <th colspan="3" class="bg-gray-200  text-dark">Initial Entry</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for item in portfolio_items|to_json %}
                                    <tr>
                                        <!-- Market-->
                                        <td class="text-start">
                                            <span style="display: none;">{{ item.sort_order}}</span>
                                            <i class="{% trade_phase_fa_icon item.trade_phase True%}"
                                                style="{% trade_phase_fa_icon item.trade_phase %}; cursor: pointer;"
                                                data-phase="{{ item.trade_phase }}"
                                                onclick="showTradePhasePopup('{{ item.trade_id }}', '{{ item.trade_phase }}', '{{ item.trade_phase_rating }}','{{ item.trade_source }}')">
                                                {{ item.trade_phase_rating }}
                                            </i>
                                            <span style="color: {% if item.trade_source == 'A' %}dodgerblue{% elif item.trade_source == 'B' %}saddlebrown{% elif item.trade_source == 'C' %}black{% endif %};">
                                                <b>{{ item.trade_source }}</b>
                                            </span>
                                        </td>
                                        <td class="text-start">
                                            <a href="{% url 'stock_quote' item.symbol %}"
                                               class="text-info text-decoration-none fw-bold">
                                                <b>{{ item.symbol }}</b>
                                            </a>
                                        </td>
                                        <td class="text-start">
                                            <b style="color: black">{% round_by_digits item.close 2 '{0}' False %}</b>
                                            <br>
                                            <a href="https://client.schwab.com/app/research/#/stocks/{{ item.symbol }}/" target="_blank">
                                                <b style="color:{% if item.chg_trend == 'UP' %}#007560{% elif item.chg_trend == 'DOWN' %}#bd1314{% else %}#000000{% endif %}">
                                                    {% round_by_digits item.chg 2 '{0}' %}
                                                </b>
                                            </a>
                                        </td>
                                        <td class="text-start">
                                            <a href="https://finance.yahoo.com/quote/{{ item.symbol }}/" target="_blank">
                                                <b  style="color:{% if item.chg_trend == 'UP' %}#007560{% elif item.chg_trend == 'DOWN' %}#bd1314{% else %}#000000{% endif %}">{% round_by_digits item.chg_pct 2 '{0}%' %}</b>
                                            </a>
                                        </td>
                                        <td class="text-start">
                                            <a href="https://www.chartmill.com/stock/quote/{{ item.symbol }}/" target="_blank">
                                                <b style="color:{% if item.chg_position > 0 %}#007560{% elif item.chg_position <= 0 %}#bd1314{% else %}#000000{% endif %}">
                                                    {% round_by_digits item.chg_position 0 '{0}' %}</b>
                                            </a>
                                        </td>
                                        <!-- Current Status -->
                                        <td class="text-md mb-0 text-primary">
                                            <b>{% round_by_digits item.invest 0 '{0}' False %}</b></td>
                                        <td class="text-md mb-0 text-primary">
                                            {% round_by_digits item.price 2 '{0}' False %}<br>@ {% round_by_digits item.quantity 0 '{0}' False %}
                                        </td>
                                        <td class="text-md mb-0 text-primary">
                                            <b>{% round_by_digits item.stop 2 '{0}' False %}</b> /<br>/
                                            <b>{% round_by_digits item.limit 2 '{0}' False %}</b></td>
                                        <!-- Risk vs Margin -->
                                        <td class="text-md mb-0" style="color: black">
                                            <b>{% round_by_digits item.dist 0 '{0}' False %}</b></td>
                                        <td class="text-md mb-0" style="color: black">
                                            <b>{% round_by_digits item.dist_pct 2 '{0}%' False %}</b></td>
                                        <td class="text-md mb-0"  style="color:{% if item.risk_trend == 'UP' %}#007560{% elif item.risk_trend == 'DOWN' %}#bd1314{% else %}#000000{% endif %}">
                                            {% round_by_digits item.risk_pct 2 '{0}%' False %}
                                        </td>
                                        <td class="text-md mb-0" style="color:{% if item.gain_trend == 'UP' %}#007560{% elif item.gain_trend == 'DOWN' %}#bd1314{% else %}#000000{% endif %}">
                                            {% round_by_digits item.gain_pct 2 '{0}%' False %}
                                        </td>
                                        <td class="text-md mb-0" style="color:{% if item.risk_trend == 'UP' %}#007560{% elif item.risk_trend == 'DOWN' %}#bd1314{% else %}#000000{% endif %}">
                                            <strong>{% round_by_digits item.risk 0 '{0}' False %}</strong>
                                        </td>
                                        <td class="text-md mb-0" style="color:{% if item.gain_trend == 'UP' %}#007560{% elif item.gain_trend == 'DOWN' %}#bd1314{% else %}#000000{% endif %}">
                                            <strong>{% round_by_digits item.gain 0 '{0}' False %}</strong>
                                        </td>
                                        <!-- Goal -->
                                        <td class="text-md mb-0">
                                            <b>{% round_by_digits item.init_risk_pct 2 '{0}%' False %}
                                                <br>{% round_by_digits item.init_risk 0 '{0}' False %}</b>
                                        </td>
                                        <!-- Statistics -->
                                        <td class="text-md mb-0 text-dark"><b>{{ item.holding_days }}</b></td>
                                        <td class="text-md mb-0 text-dark">
                                            <span style="font-size: small">
                                                {{ item.industry}}<br>
                                                {{ item.exchange}} @ <b style="color: black;">{{ item.sector}}</b>
                                            </span>
                                        </td>
                                        <!-- Entry Action -->
                                        <td class="text-md mb-0 text-dark">{{ item.init_stop_date|format_date:'%m/%d/%Y' }}</td>
                                        <td class="text-md mb-0 text-dark">{% round_by_digits item.init_invest 0 '{0}' False %}</td>
                                        <td class="text-md mb-0 text-dark">
                                            <b style="color:#000;">{% round_by_digits item.price 2 '{0}' False %}</b>
                                            @ <b style="color:#000;">{% round_by_digits item.init_quantity 0 '{0}' False %}</b>
                                            <br>
                                            {% round_by_digits item.init_stop 2 '{0}' False %}
                                            / {% round_by_digits item.init_limit 2 '{0}' False %}
                                        </td>
                                        <!--<div id="sliderDouble"></div>-->
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="holdings_panel" class="col-12">
                <div class="card">
                    <!-- Card header -->
                    <div class="card-header pb-0">
                        <p>
                            <button type="button" class="btn bg-gradient-info w-10 mb-0 toast-btn"
                                    data-bs-toggle="collapse" href="#symbolCollapse" role="button" aria-expanded="false"
                                    aria-controls="symbolCollapse">
                                +&nbsp; Add Symbol
                            </button>
                            <button type="button" class="btn bg-gradient-default w-10 mb-0 toast-btn"
                                    data-bs-toggle="collapse" data-bs-target="#reorderCollapse" aria-expanded="false"
                                    aria-controls="reorderCollapse">
                                Reorder
                            </button>
                        </p>
                        <div class="collapse" id="symbolCollapse">
                            <div class="card text-sm">
                                <div class="card-header me-2 d-flex align-items-start col-md-4">
                                    <div class="input-group" style="border-right: 1px solid lightgray;">
                                        <span class="input-group-text"><i class="fas fa-search" aria-hidden="true"></i></span>
                                        <input id="header_search" type="text" class="form-control" autocomplete="off"
                                               placeholder="Stock name or symbol"
                                               data-bs-toggle="dropdown" aria-expanded="false"
                                               oninput="symbolSearchAutoReminder(event, 'symbol_auto_reminder_results')"
                                               onkeydown="symbolSearchKeyDown(event, 'symbol_auto_reminder_results')"
                                               onblur="symbolSearchBlur('symbol_auto_reminder_results')"
                                               onfocus="symbolFocus('symbol_auto_reminder_results')">
                                        <input id="currentPortfolioIndex" type="hidden"
                                               value="{{ portfolio.portfolio_id }}"/>
                                        <ul id="symbol_auto_reminder_results" class="dropdown-menu"
                                            aria-labelledby="header_search"></ul>
                                    </div>
                                </div>
                                <div class=" card-body pt-0">
                                    <b>Enter Symbols or company names</b>
                                    <br/>Tip: Use Comma to separate multiple symbols and then press enter
                                </div>
                            </div>
                        </div>
                        <div class="collapse" id="reorderCollapse">
                            <div class="card card-body">
                                order Collapse
                            </div>
                        </div>
                    </div>
                    <div class="card-body px-0 pb-0">
                        <div class="table-responsive">
                            <table class="table table-flush table-hover" id="holding-list">
                                <thead class="thead-light">
                                <tr>
                                    <th>Symbol</th>
                                    <th>Status <i class="fas fa-exclamation-circle custom-tooltip"></i></th>
                                    <th>Shares</th>
                                    <th>Last Price</th>
                                    <th>Average Cost / Share</th>
                                    <th>Total Cost</th>
                                    <th>Total Dividend Income</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for item in portfolio_items|to_json %}
                                    <tr>
                                        <td>
                                            <i id="expand" class="fas fa-chevron-right"
                                               style="cursor:pointer; margin-right: 10px;"
                                               onclick="toggleDetails(this)"></i>
                                            <a href="{% url 'stock_quote' item.symbol %}"
                                               class="text-info text-decoration-none fw-bold">
                                                <b>{{ item.symbol }}</b>
                                            </a>
                                        </td>
                                        <td class="text-sm">
                                            {% if  item.quantity is None %}
                                                <span class="badge badge-light badge-sm"><i
                                                        class="fas fa-dot-circle"></i> No Shares</span>
                                            {% elif item.quantity > 0 %}
                                                <span class="badge badge-success badge"><i
                                                        class="fas fa-dot-circle"></i> Open</span>
                                            {% else %}
                                                <span class="badge badge-secondary badge-sm"><i
                                                        class="fas fa-dot-circle"></i> Closed</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-sm mb-0 text-dark">
                                            <b>{% round_by_digits item.quantity 0 '{0}' %}</b></td>
                                        <td class="text-sm mb-0 text-dark">
                                            <b>{% round_by_digits item.close 2 '$ {0}' %}</b></td>
                                        <td class="text-sm mb-0 text-dark">
                                            <b>{% round_by_digits item.average_price 2 '$ {0}' %}</b></td>
                                        <td class="text-sm mb-0 text-dark">
                                            <b>{% round_by_digits item.market_value 2 '$ {0}' %}</b></td>
                                        <td class="text-sm">
                                            <a href="javascript:" data-bs-toggle="tooltip"
                                               data-bs-original-title="Preview product">
                                                <i class="fas fa-eye text-secondary"></i>
                                            </a>
                                            <a href="javascript:" class="mx-3" data-bs-toggle="tooltip"
                                               data-bs-original-title="Edit product">
                                                <i class="fas fa-user-edit text-secondary"></i>
                                            </a>
                                            <a href="javascript:" data-bs-toggle="tooltip"
                                               data-bs-original-title="Delete product">
                                                <i class="fas fa-trash text-secondary"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    <tr class="details-row" style="display: none;">
                                        <td colspan="8">
                                            <!-- Add Transaction Button -->
                                            <div class="row mt-4">
                                                <button id="addTransactionButton-{{ item.portfolio_item_id }}"
                                                        type="button"
                                                        class="btn bg-gradient-info btn-sm w-15 mb-3 toast-btn"
                                                        onclick="">
                                                    +&nbsp; Add a Transaction
                                                </button>
                                            </div>

                                            <div class="details-content">
                                                <div id="addTransactionForm-{{ item.portfolio_item_id }}"
                                                     style="display: none; position: relative;">
                                                    <button type="button" class="btn-close bg-primary" onclick=""
                                                            style="position: absolute; top: 10px; right: 10px;">&times;
                                                    </button>
                                                    <form id="addTransactionFormContent-{{ item.portfolio_item_id }}"
                                                          onsubmit="" data-portfolio-id="{{ portfolio.portfolio_id }}"
                                                          data-portfolio-item-id="{{ item.portfolio_item_id }}">
                                                        <!-- Form fields for adding a transaction -->
                                                        <div class="row mt-3">
                                                            <div class="col-3">
                                                                <b class="text-dark">Add a new transaction
                                                                    for {{ item.symbol }} - ({{ item.symbol_name }})</b>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-2">
                                                                <label for="type" class="form-label">Transaction
                                                                    Type</label>
                                                                <select class="form-control form-control-sm" name="type"
                                                                        required>
                                                                    <option value="buy">Buy</option>
                                                                    <option value="sell">Sell</option>
                                                                    <option value="sell Short">Sell Short</option>
                                                                    <option value="buy to cover">Buy to Cover</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-2">
                                                                <label for="date" class="form-label">Trade Date</label>
                                                                <input type="date" class="form-control form-control-sm"
                                                                       name="date" required>
                                                            </div>
                                                            <div class="col-1">
                                                                <label for="quantity" class="form-label">Shares</label>
                                                                <input type="number"
                                                                       class="form-control form-control-sm"
                                                                       name="quantity" required>
                                                            </div>
                                                            <div class="col-1">
                                                                <label for="price" class="form-label">Cost /
                                                                    Share</label>
                                                                <input type="number" step="0.01"
                                                                       class="form-control form-control-sm" name="price"
                                                                       required>
                                                            </div>
                                                            <div class="col-1">
                                                                <label for="commission"
                                                                       class="form-label">Commission</label>
                                                                <input type="number" step="0.01"
                                                                       class="form-control form-control-sm"
                                                                       name="commission">
                                                            </div>
                                                            <div class="col-5">
                                                                <label for="notes" class="form-label">Notes</label>
                                                                <input type="text" class="form-control form-control-sm"
                                                                       name="notes">
                                                            </div>
                                                        </div>
                                                        <div class="row mt-3">
                                                            <div class="col-3">
                                                                <button type="submit"
                                                                        class="btn btn-outline-primary btn-sm mb-2 px-3 up">
                                                                    Save transaction
                                                                </button> &nbsp;
                                                                <button type="reset"
                                                                        class="btn btn-outline-dark btn-sm mb-2 px-3 up">
                                                                    Cancel
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </form>
                                                </div>

                                                <!-- Existing Transactions -->
                                                <div id="transactions-{{ item.portfolio_item_id }}">
                                                    <!-- Transactions will be loaded here -->
                                                </div>

                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}

                                </tbody>
                                <tfoot>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Status <i class="fas fa-exclamation-circle custom-tooltip"></i></th>
                                    <th>Shares</th>
                                    <th>Last Price</th>
                                    <th>Average Cost / Share</th>
                                    <th>Total Cost</th>
                                    <th>Total Dividend Income</th>
                                </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="fundamentals_panel" class="col-12">
                Fundamentals
            </div>
        </div>
        {% include 'includes/footer.html' %}
    </div>

    <!-- Trade Phase  Modal -->
    <div class="modal fade" id="tradePhaseModal" tabindex="-1" role="dialog" aria-labelledby="tradePhaseModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tradePhaseModalLabel">Select Trade Phase</h5>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col">
                            <label for="tradePhaseSelect" class="form-label">Phase</label>
                            <select id="tradePhaseSelect" class="form-control">
                                {% for value, label in trade_phase_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col">
                            <label for="tradeRatingSelect" class="form-label">Phase Rating</label>
                            <select id="tradeRatingSelect" class="form-control">
                                {% for value, label in trade_phase_rating_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col">
                            <label for="tradeSourceSelect" class="form-label">Source</label>
                            <select id="tradeSourceSelect" class="form-control">
                                {% for value, label in trade_source_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="closeTradePhaseModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateTradePhase()">Update</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}
{% block extra_js %}
  <script src="{% static 'assets/js/plugins/datatables.js' %}"></script>
  <script>
    function pagination(element_id, per_page=12) {
        if (document.getElementById(element_id)) {
            const dataTableSearch = new simpleDatatables.DataTable(`#${element_id}`, {
                searchable: true,
                fixedHeight: false,
                perPage: per_page
            });
            document.querySelectorAll(".export").forEach(function (el) {
                el.addEventListener("click", function (e) {
                    let type = el.dataset.type;
                    let data = { type: type, filename: "soft-ui-" + type, };
                    if (type === "csv") { data.columnDelimiter = "|"; }
                    dataTableSearch.export(data);
                });
            });
        }
    }
    pagination('summary-list', 15);
    pagination('holding-list',20);

    document.addEventListener('DOMContentLoaded', function() {
        const summary_btn = document.getElementById('summary_btn');
        const holding_btn = document.getElementById('holding_btn');
        const fundamental_btn = document.getElementById('fundamental_btn');

        const summaryPanel = document.getElementById('summary_panel');
        const holdingsPanel = document.getElementById('holdings_panel');
        const fundamentalsPanel = document.getElementById('fundamentals_panel');

        function showPanel(panelToShow) {
            summaryPanel.style.display = 'none';
            holdingsPanel.style.display = 'none';
            fundamentalsPanel.style.display = 'none';
            panelToShow.style.display = 'block';
        }

        summary_btn.addEventListener('click', function () {showPanel(summaryPanel);});
        holding_btn.addEventListener('click', function () {showPanel(holdingsPanel);});
        fundamental_btn.addEventListener('click', function () {showPanel(fundamentalsPanel);});

        // Initialize by showing the summary panel
        showPanel(summaryPanel);
    });

    function toggleDetails(button) {
        const detailsRow = button.closest('tr').nextElementSibling;
        const icon = button;
        if (detailsRow.style.display === 'none') {
            detailsRow.style.display = 'table-row';
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-down');
            icon.style.marginRight = '4px';
        } else {
            detailsRow.style.display = 'none';
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-right');
            icon.style.marginRight = '10px';
        }
    }

    function submitTransaction(event, symbol) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        formData.append('symbol', symbol);
        // Get CSRF token from the cookie
        const csrftoken = getCookie('csrftoken');
        formData.append('csrfmiddlewaretoken', csrftoken);

        fetch('/portfolio/add/transaction/', {
            method: 'POST',
            body: formData,
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Transaction submitted successfully');
                    form.reset();
                } else {
                    alert('Error submitting transaction: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error submitting transaction');
            });
    }

    function deleteBasket(transaction_id) {
        if (confirm('Are you sure you want to delete this transaction?')) {
            fetch(`/portfolio/delete/${transaction_id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Basket deleted successfully');
                        location.reload();
                    } else {
                        alert('Error deleting basket: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting basket');
                });
        }
    }

    function refreshTask(input,period_select,interval_select) {
        let symbolInput = document.getElementById(input).value;
        symbolInput = symbolInput.replace(/,/g, '|'); // Replace commas with pipe characters
        const period = document.getElementById(period_select).value; // Get the selected period
        const interval = document.getElementById(interval_select).value; // Get the selected interval
        refreshSymbol(symbolInput,period,interval, '{{ csrf_token }}')
    }

    /////////////////////// Trade Phase ////////////////////////////
    function showTradePhasePopup(tradeId, phase, phase_rating, source) {

        const sourceSelect = document.getElementById('tradeSourceSelect');
        sourceSelect.value = source;

        const phaseSelect = document.getElementById('tradePhaseSelect');
        phaseSelect.value = phase;
        phaseSelect.setAttribute('data-trade-id', tradeId);

        const phaseRatingSelect = document.getElementById('tradeRatingSelect');
        phaseRatingSelect.value = phase_rating;

        $('#tradePhaseModal').modal('show');
    }

    function closeTradePhaseModal() {
        $('#tradePhaseModal').modal('hide');
    }

    function updateTradePhase() {
        const phaseSelect = document.getElementById('tradePhaseSelect');
        const phase = phaseSelect.value;
        const tradeId = phaseSelect.getAttribute('data-trade-id');

        const sourceSelect = document.getElementById('tradeSourceSelect');
        const source = sourceSelect.value;

        const ratingSelect = document.getElementById('tradeRatingSelect');
        const rating = ratingSelect.value;

        fetch(`/position/holding/trade/${tradeId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ trade_phase: phase, trade_rating: rating, trade_source: source })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showNotification('success', 'Phase updated', 'Phase updated successfully', new Date().toLocaleTimeString());
                location.reload();
            } else {
                showNotification('error', 'Phase updated', 'Failed to update trade phase', new Date().toLocaleTimeString());
            }
            $('#tradePhaseModal').modal('hide');
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('error', 'Phase updated', error, new Date().toLocaleTimeString());
            $('#tradePhaseModal').modal('hide');
        });
    }


  </script>

{% endblock extra_js %}